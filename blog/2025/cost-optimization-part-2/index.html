<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg" data-component-name="Image2ToDOM" rel="external nofollow noopener"><div class="image2-inset"> <picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 1456w" sizes="100vw"></source><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg" width="728" height="728" data-attrs='{"src":"https://substack-post-media.s3.amazonaws.com/public/images/9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg","srcNoWatermark":null,"fullscreen":false,"imageSize":"normal","height":1456,"width":1456,"resizeWidth":728,"bytes":372437,"alt":"","title":null,"type":"image/jpeg","href":null,"belowTheFold":false,"topImage":true,"internalRedirect":null,"isProcessing":false}' class="sizing-normal" alt="" title="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9def3797-326b-4217-a840-5a3c49ffdd3a_2048x2048.jpeg 1456w" sizes="100vw" fetchpriority="high"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"> <div class="pencraft pc-reset icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></div> <div class="pencraft pc-reset icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div> </div></div> </div></a></figure></div> <p>In the <a href="https://shubhamgondane.substack.com/p/data-engineering-cost-optimization?r=52p1v" rel="external nofollow noopener" target="_blank">previous post</a>, I covered a few general optimization techniques to reduce the cost of running your Spark pipelines. These techniques were simple enough to try for quick gains. This post focuses on advanced techniques and combinations to further optimize your pipeline.</p> <p></p> <div class="subscription-widget-wrap-editor" data-attrs='{"url":"https://shubhamgondane.substack.com/subscribe?","text":"Subscribe","language":"en"}' data-component-name="SubscribeWidgetToDOM"><div class="subscription-widget show-subscribe"> <div class="preamble"><p class="cta-caption">Thanks for reading The Data Engineering Newsletter! Subscribe for free to receive new posts and support my work.</p></div> <form class="subscription-widget-subscribe"> <input type="email" class="email-input" name="email" placeholder="Type your email…" tabindex="-1"><input type="submit" class="button primary" value="Subscribe"><div class="fake-input-wrapper"> <div class="fake-input"></div> <div class="fake-button"></div> </div> </form> </div></div> <h2>Compression</h2> <div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png" data-component-name="Image2ToDOM" rel="external nofollow noopener"><div class="image2-inset"> <picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 1456w" sizes="100vw"></source><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png" width="1389" height="1095" data-attrs='{"src":"https://substack-post-media.s3.amazonaws.com/public/images/b83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png","srcNoWatermark":null,"fullscreen":null,"imageSize":null,"height":1095,"width":1389,"resizeWidth":null,"bytes":1022847,"alt":null,"title":null,"type":"image/png","href":null,"belowTheFold":false,"topImage":false,"internalRedirect":null,"isProcessing":false}' class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb83e16f1-4e26-4208-a526-ca6c02b6d649_1389x1095.png 1456w" sizes="100vw"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"> <div class="pencraft pc-reset icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></div> <div class="pencraft pc-reset icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div> </div></div> </div></a></figure></div> <p>Data compression involves making data smaller without losing its essential information. In Spark, where we process large volumes of data, compression helps improve pipeline performance by:</p> <ul> <li><p><strong>Reducing disk I/O and network usage:</strong> Compressed data takes up less space, leading to faster read/write operations and reduced data transfer times.</p></li> <li><p><strong>Lowering storage costs:</strong> Smaller data footprints translate to lower storage costs, especially in cloud environments.</p></li> </ul> <p>Spark offers various compression codecs, each with its own benefits and tradeoffs:</p> <ul> <li><p><strong>Snappy:</strong> Developed by Google, Snappy prioritizes high speeds and reasonable compression over maximum compression ratios. It's a good general-purpose codec.</p></li> <li><p><strong>Zstd (Zstandard):</strong> Developed by Facebook, Zstd provides high compression ratios and fast compression speeds. It even includes a "dictionary compression" mode for small data.</p></li> <li><p><strong>LZ4:</strong> This lossless compression algorithm offers extremely fast compression and decompression speeds, often reaching RAM speed limits on multi-core systems.</p></li> </ul> <p><strong>Enabling Compression in Spark:</strong></p> <p>The default compression codec in Spark is Snappy. To change it, for example to Zstd, you can set the compression option during write operations:</p> <p>PySpark</p> <pre><code><code>df.write.option("compression", "zstd").parquet("path/to/output") 
</code></code></pre> <p>This code snippet shows how to write the DataFrame to Parquet files at the specified path using Zstd compression.</p> <p>Selecting the optimal compression codec depends heavily on your data characteristics and specific use case. Snappy is a popular choice due to its speed and reasonable compression. However, if minimizing storage space is critical, consider Zstd, which offers higher compression ratios but may require slightly more processing time. Ultimately, the best approach is to experiment with different codecs and evaluate their performance based on your needs and priorities.</p> <p></p> <h2>Salting</h2> <p>Salting is a well-known technique for handling data skew in Apache Spark. Data skew occurs when data is unevenly distributed across partitions, leading to inefficient resource utilization, longer processing times, and increased costs.</p> <p>For example, imagine joining two Spark DataFrames where one has skewed data. This means a join column's values are concentrated in a few partitions, while others remain relatively empty. This imbalance forces a few partitions to do most of the work, creating bottlenecks.</p> <p>Here's how salting can help:</p> <ol> <li><p><strong>Identify the skewed key:</strong> Determine the column causing the skew.</p></li> <li><p><strong>Add a random salt to the key:</strong> Introduce random prefixes or suffixes to the skewed key values. This redistributes data more evenly across partitions.</p></li> <li><p><strong>Repartition and join:</strong> Repartition both DataFrames using the salted key and perform the join.</p></li> </ol> <p><strong>Example:</strong></p> <p>PySpark</p> <pre><code><code>df = df.withColumn('salted_col', concat(col('skewed_col'), lit('_'), rand())) 
</code></code></pre> <p>This code adds a random number to the skewed_col creating a salted_col.</p> <p>While salting is a valuable tool for mitigating data skew, it's crucial to understand your data and assess whether salting is the appropriate solution. In some cases, alternative techniques like broadcast joins or pre-processing the skewed data might be more effective.</p> <p></p> <h2>Cost-Based Optimizer (CBO)</h2> <div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg" data-component-name="Image2ToDOM" rel="external nofollow noopener"><div class="image2-inset"> <picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 1456w" sizes="100vw"></source><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg" width="2048" height="827" data-attrs='{"src":"https://substack-post-media.s3.amazonaws.com/public/images/d12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg","srcNoWatermark":null,"fullscreen":null,"imageSize":null,"height":827,"width":2048,"resizeWidth":null,"bytes":450602,"alt":null,"title":null,"type":"image/jpeg","href":null,"belowTheFold":true,"topImage":false,"internalRedirect":null,"isProcessing":false}' class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fd12be1da-b217-4b08-a54c-842d86a34d14_2048x827.jpeg 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"> <div class="pencraft pc-reset icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></div> <div class="pencraft pc-reset icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div> </div></div> </div></a></figure></div> <p>The Cost-Based Optimizer (CBO) is a technique in Spark SQL that enhances query performance. It uses statistical data to estimate the cost of different query execution plans and selects the most efficient one.</p> <p>To leverage CBO, you first need to collect table and column statistics using the <code>ANALYZE TABLE</code> command. This provides Spark with information about data distribution, cardinality, and other factors. CBO is disabled by default, but you can enable it by setting the following configuration in your app:</p> <pre><code><code>spark.sql.cbo.enabled = true</code></code></pre> <p>By analyzing these statistics, CBO helps Spark make informed decisions about how to execute SQL queries, leading to significant performance improvements, especially for complex queries and large datasets. This translates to faster query processing and reduced resource consumption.</p> <p></p> <h2>Checkpointing</h2> <div class="captioned-image-container"><figure><a class="image-link image2 is-viewable-img" target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg" data-component-name="Image2ToDOM" rel="external nofollow noopener"><div class="image2-inset"> <picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 1456w" sizes="100vw"></source><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg" width="1704" height="1383" data-attrs='{"src":"https://substack-post-media.s3.amazonaws.com/public/images/246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg","srcNoWatermark":null,"fullscreen":null,"imageSize":null,"height":1383,"width":1704,"resizeWidth":null,"bytes":307553,"alt":null,"title":null,"type":"image/jpeg","href":null,"belowTheFold":true,"topImage":false,"internalRedirect":null,"isProcessing":false}' class="sizing-normal" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F246a4784-f33d-412a-a111-131a41b20477_1704x1383.jpeg 1456w" sizes="100vw" loading="lazy"></picture><div class="image-link-expand"><div class="pencraft pc-display-flex pc-gap-8 pc-reset"> <div class="pencraft pc-reset icon-container restack-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg></div> <div class="pencraft pc-reset icon-container view-image"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-maximize2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" x2="14" y1="3" y2="10"></line><line x1="3" x2="10" y1="21" y2="14"></line></svg></div> </div></div> </div></a></figure></div> <p></p> <p>In ETL processes, we often use caching or persisting when performing multiple actions on the same DataFrame. The <code>cache()</code> method, by default, stores the DataFrame in memory. The <code>persist()</code> method offers more flexibility, allowing you to choose a specific storage level (e.g., memory-only, disk-only, or a combination).</p> <p>However, checkpointing works differently. Instead of storing the DataFrame in memory, it saves it to a persistent storage system like HDFS or S3. A key difference is that checkpointing truncates the DataFrame's lineage.</p> <p>While checkpointing might seem inefficient at first glance—retrieving data from disk is slower than accessing it from memory, and the lineage information is lost—it offers significant advantages in certain scenarios.</p> <p>Checkpointing is particularly useful in stateful transformations, where data is processed over multiple batches. In these transformations, a long chain of dependencies between RDDs (Resilient Distributed Datasets) can develop. This makes recovery from failures time-consuming, as Spark needs to retrace the entire lineage to rebuild the data.</p> <p>Checkpointing helps by breaking this dependency chain. By saving RDDs to persistent storage at specific points, it provides a recovery point. In case of an error, Spark can restart from the last checkpoint, significantly reducing recovery time and improving fault tolerance.</p> <p>This approach is especially valuable for large datasets and complex computations, where the overhead of saving intermediate data to disk is outweighed by the potential cost of re-computing everything in case of a failure.</p> <h2>Conclusion</h2> <p>This is not an exhaustive list; many options exist for Spark optimization, ranging from simple "low-hanging fruit" to complex fine-tuning. However, as you progress from basic to advanced techniques, you'll encounter diminishing returns. At some point, it becomes impractical to invest further time and resources into optimizing an already highly optimized system.</p> <p></p> <p><strong>A note about the images:</strong> The visuals in this article were created with the assistance of Imagen 3, Google's text-to-image AI model.</p> <div class="subscription-widget-wrap-editor" data-attrs='{"url":"https://shubhamgondane.substack.com/subscribe?","text":"Subscribe","language":"en"}' data-component-name="SubscribeWidgetToDOM"><div class="subscription-widget show-subscribe"> <div class="preamble"><p class="cta-caption">Thanks for reading The Data Engineering Newsletter! Subscribe for free to receive new posts and support my work.</p></div> <form class="subscription-widget-subscribe"> <input type="email" class="email-input" name="email" placeholder="Type your email…" tabindex="-1"><input type="submit" class="button primary" value="Subscribe"><div class="fake-input-wrapper"> <div class="fake-input"></div> <div class="fake-button"></div> </div> </form> </div></div> </body></html>